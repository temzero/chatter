version: "3.8"

services:
  # React Frontend
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      - ./client:/app
      - /app/node_modules
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    env_file:
      - ./client/.env
    command: npm run dev -- --host
    stdin_open: true
    tty: true
    depends_on:
      - server
      - livekit

  # NestJS Backend
  server:
    build:
      context: ./backend/server
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - ./backend/server:/app
      - /app/node_modules
    env_file:
      - ./backend/server/.env # <-- use env_file instead of huge environment block
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: npm run start:dev
    stdin_open: true
    tty: true
    depends_on:
      - livekit

  # LiveKit Server
  livekit:
    image: livekit/livekit-server:latest
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
      - "3478:3478/udp"
    volumes:
      - ./backend/livekit-server/livekit.yaml:/livekit.yaml:ro
    command: --config /livekit.yaml
    restart: unless-stopped

# Uncomment if you want a local PostgreSQL database
#  db:
#    image: postgres:16
#    restart: always
#    environment:
#      POSTGRES_USER: ${POSTGRES_USER}
#      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
#      POSTGRES_DB: ${POSTGRES_DB}
#    ports:
#      - "5432:5432"
#    volumes:
#      - db_data:/var/lib/postgresql/data

#volumes:
#  db_data:

networks:
  default:
    driver: bridge
